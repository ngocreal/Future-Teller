"use strict";(()=>{var e={};e.id=204,e.ids=[204],e.modules={1738:e=>{e.exports=require("multer")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,a){return a in t?t[a]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,a)):"function"==typeof t&&"default"===a?t:void 0}}})},1383:(e,t,a)=>{a.r(t),a.d(t,{config:()=>T,default:()=>P,routeModule:()=>h});var r={};a.r(r),a.d(r,{config:()=>f,default:()=>g});var i=a(1802),s=a(7153),n=a(6249),o=a(1417),l=a(1738),u=a.n(l),d=a(7147),E=a(1017),m=a.n(E);let c=u()({storage:u().diskStorage({destination:"./public/uploads/",filename:(e,t,a)=>{a(null,Date.now()+"-"+Math.round(1e9*Math.random())+m().extname(t.originalname))}})}),p=(e,t,a)=>new Promise((r,i)=>{a(e,t,e=>e instanceof Error?i(e):r(e))}),f={api:{bodyParser:!1}};async function g(e,t){let{method:a}=e;try{switch(a){case"GET":let[r]=await o.Z.query("SELECT * FROM majors");t.status(200).json(r);break;case"POST":await p(e,t,c.single("image"));let{title:i}=e.body,[s]=await o.Z.query("SELECT * FROM majors WHERE title = ?",[i]);if(s.length>0)return t.status(400).json({error:"Ti\xeau đề đ\xe3 tồn tại"});let n=e.file?`/uploads/${e.file.filename}`:null;await o.Z.query("INSERT INTO majors (title, image) VALUES (?, ?)",[i,n]),t.status(201).json({message:"Th\xeam th\xe0nh c\xf4ng"});break;case"PUT":await p(e,t,c.single("image"));let{id:l,title:u}=e.body,[E]=await o.Z.query("SELECT * FROM majors WHERE title = ? AND id != ?",[u,l]);if(E.length>0)return t.status(400).json({error:"Ti\xeau đề đ\xe3 tồn tại"});let[f]=await o.Z.query("SELECT image FROM majors WHERE id = ?",[l]);if(e.file&&f[0]?.image){let e=m().join(process.cwd(),"public",f[0].image);await d.promises.unlink(e).catch(()=>{})}let g=e.file?`/uploads/${e.file.filename}`:f[0]?.image;await o.Z.query("UPDATE majors SET title = ?, image = ? WHERE id = ?",[u,g,l]),t.status(200).json({message:"Sửa th\xe0nh c\xf4ng"});break;case"DELETE":let P="";e.on("data",e=>{P+=e.toString()}),await new Promise(t=>e.on("end",t));let{id:T}=P?JSON.parse(P):{};if(!T)return t.status(400).json({error:"Thiếu id trong body"});let[h]=await o.Z.query("SELECT image FROM majors WHERE id = ?",[T]);if(h[0]?.image){let e=m().join(process.cwd(),"public",h[0].image);await d.promises.unlink(e).catch(()=>{})}await o.Z.query("DELETE FROM majors WHERE id = ?",[T]),t.status(200).json({message:"X\xf3a th\xe0nh c\xf4ng"});break;default:t.setHeader("Allow",["GET","POST","PUT","DELETE"]),t.status(405).end(`Method ${a} Not Allowed`)}}catch(e){t.status(500).json({error:e.message})}}let P=(0,n.l)(r,"default"),T=(0,n.l)(r,"config"),h=new i.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/majors",pathname:"/api/majors",bundlePath:"",filename:""},userland:r})},1417:(e,t,a)=>{a.d(t,{Z:()=>i});let r=require("mysql2/promise"),i=a.n(r)().createPool({host:process.env.DB_HOST,port:process.env.DB_PORT,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_NAME})},7153:(e,t)=>{var a;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return a}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(a||(a={}))},1802:(e,t,a)=>{e.exports=a(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var a=t(t.s=1383);module.exports=a})();