"use strict";(()=>{var e={};e.id=957,e.ids=[957],e.modules={1738:e=>{e.exports=require("multer")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7147:e=>{e.exports=require("fs")},1017:e=>{e.exports=require("path")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,i){return i in t?t[i]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,i)):"function"==typeof t&&"default"===i?t:void 0}}})},8828:(e,t,i)=>{i.r(t),i.d(t,{config:()=>P,default:()=>h,routeModule:()=>T});var r={};i.r(r),i.d(r,{config:()=>p,default:()=>f});var a=i(1802),n=i(7153),s=i(6249),o=i(1417),u=i(1738),l=i.n(u),d=i(7147),E=i(1017),m=i.n(E);let c=l()({storage:l().diskStorage({destination:"./public/uploads/",filename:(e,t,i)=>{i(null,Date.now()+"-"+Math.round(1e9*Math.random())+m().extname(t.originalname))}})}),g=(e,t,i)=>new Promise((r,a)=>{i(e,t,e=>e instanceof Error?a(e):r(e))}),p={api:{bodyParser:!1}};async function f(e,t){let{method:i}=e;try{switch(i){case"GET":let[r]=await o.Z.query("SELECT * FROM times");t.status(200).json(r);break;case"POST":await g(e,t,c.single("image"));let{title:a}=e.body;if(!a)return t.status(400).json({error:"Ti\xeau đề kh\xf4ng được để trống"});let[n]=await o.Z.query("SELECT * FROM times WHERE title = ?",[a]);if(n.length>0)return t.status(400).json({error:"Ti\xeau đề đ\xe3 tồn tại"});let s=e.file?`/uploads/${e.file.filename}`:null;await o.Z.query("INSERT INTO times (title, image) VALUES (?, ?)",[a,s]),t.status(201).json({message:"Th\xeam th\xe0nh c\xf4ng"});break;case"PUT":await g(e,t,c.single("image"));let{id:u,title:l}=e.body;if(!u||isNaN(u))return t.status(400).json({error:"ID kh\xf4ng hợp lệ"});if(!l)return t.status(400).json({error:"Ti\xeau đề kh\xf4ng được để trống"});let[E]=await o.Z.query("SELECT * FROM times WHERE title = ? AND id != ?",[l,u]);if(E.length>0)return t.status(400).json({error:"Ti\xeau đề đ\xe3 tồn tại"});let[p]=await o.Z.query("SELECT image FROM times WHERE id = ?",[u]);if(0===p.length)return t.status(404).json({error:"Bản ghi kh\xf4ng tồn tại"});if(e.file&&p[0]?.image){let e=m().join(process.cwd(),"public",p[0].image);await d.promises.unlink(e).catch(()=>{})}let f=e.file?`/uploads/${e.file.filename}`:p[0]?.image;await o.Z.query("UPDATE times SET title = ?, image = ? WHERE id = ?",[l,f,u]),t.status(200).json({message:"Sửa th\xe0nh c\xf4ng"});break;case"DELETE":let h="";e.on("data",e=>{h+=e.toString()}),await new Promise(t=>e.on("end",t));let{id:P}=h?JSON.parse(h):{};if(!P||isNaN(P))return t.status(400).json({error:"ID kh\xf4ng hợp lệ"});let[T]=await o.Z.query("SELECT image FROM times WHERE id = ?",[P]);if(0===T.length)return t.status(404).json({error:"Bản ghi kh\xf4ng tồn tại"});if(T[0]?.image){let e=m().join(process.cwd(),"public",T[0].image);await d.promises.unlink(e).catch(()=>{})}await o.Z.query("DELETE FROM times WHERE id = ?",[P]),t.status(200).json({message:"X\xf3a th\xe0nh c\xf4ng"});break;default:t.setHeader("Allow",["GET","POST","PUT","DELETE"]),t.status(405).end(`Method ${i} Not Allowed`)}}catch(e){t.status(500).json({error:e.message})}}let h=(0,s.l)(r,"default"),P=(0,s.l)(r,"config"),T=new a.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/times",pathname:"/api/times",bundlePath:"",filename:""},userland:r})},1417:(e,t,i)=>{i.d(t,{Z:()=>a});let r=require("mysql2/promise"),a=i.n(r)().createPool({host:process.env.DB_HOST,port:process.env.DB_PORT,user:process.env.DB_USER,password:process.env.DB_PASSWORD,database:process.env.DB_NAME})},7153:(e,t)=>{var i;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},1802:(e,t,i)=>{e.exports=i(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var i=t(t.s=8828);module.exports=i})();